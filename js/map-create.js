
var d1 = "333333333333333333333300000000003333333333333333333333333143141300314134133300000000003334134133003411341333330000000000000000003300000000003300000041000000000033340000000000000000001300000000003100000011000000000013310000003330000000004300000000003400330033003333330043330033003330000330001300000000003100330011003333330033310033003330000330003300000000003300000014000000000013340000003330000000000300000000003000000033000000000013330000000000000000000300000000003000000000000000000033300000000000031413143300000000003300000000000000000003300033000000034143143300000000003100000000003300000003330033003300000000004300000000003100033330001400000033310033001100033333301300000000003400033330004100000013340033004400033333303300000000003300033330001100330013330033003300000000003333333333333300000000003300330033310033001100000000003300000000003300000000004100000043310000001100000000000000000000000000000000001400000013330000003300000000000000000000000000000000003300000033333414133331141333000000000000000000333114133334114333333333333333333333000333330033333000333333333333333333000000000000000030000300000000003000030000000000000000000000000000000030000300000000003003330000000000000000000000000000000030000300333333003003330000000000000000000000000000000030000300333333003000030000000000000000000000000000000030000000000000000000330000000000000000000000000000000030000000000000000000330000000000000000000000000000000030000300333333003000030000000000000000000000000000000030000300333333003000030000000000000000000000000000000030000300000000003000330000000000000000000000000000000030000300000000003000330000000000000000333333333333333333000333330033333000030000000000000000333414133334141333000000000000000003330000000000000000330000000000000000000000000000000003330000000000000000310000000000000000000003300000000330030000000000000000340033000000000000003303303300330330330000000000000000330033003330000000003333333333333333330000000000000000310033003330000000003300000000000000000000000000000000310033003330000000001300000000000000000000000000000000330033003330000000004300000000000000000000000000000000300033000000034431413300000000000000000000000000000000300000000000031431443300000000000000000000000000000000330000003300000000000300000000000000000000000000000000340000001100000000000300000000000000000000000000000000310000004400000000003300000000000000000000000000000000330033001100333333001300000000000000000000000000000000340033003300333333001300000000000000000000000000000000310000001400000000004300000000000000000000000000000000330000004100000000003300000000000000000000000000000000333113143300344131133300000000000000000000000000000000333333333333333333333300000000000000000000000000000000";
var d2 = "333333333333333333333333333333333333333333333333333333330031113331141300133333333333333333003111133411430033303300000000000000433333333333333334000000014000003303303300000000000000133333333333333331003330041000003303330003333000003300333333333333333334003330014000000033310003333000001400333333333333333333000000033000000013340003333003304100333333333333333334000000000003300013310003333003301400133333333333333331000000000004400013310000000003301400133333333333333331033330000004400043333341130003304400433333333333333334033330000004400043334143330003301100333333333333333333033330000004400013310000000003304400333333333333333333033330034443400013310000000000001100333333333333333333000000034444300013330330333000003300133333333333333331003300000000003333300330333000000000433333333333333331003300000000003303300000000000000000133333333333333331000000000000000003334141333411333141333333333333333333411333111433311433333333333333333333331133311113331133333333333333333333333333333333333333310000000000000013333333333333333333333333333333333333310000000000000013333333333333333333333333333333333333310033333333330033333333333333333333333333333333333333310033333333330003333333333333333333333333333333333333330033333333330003333333333333333333333333333333333333310033333333333303333333333333333333333333333333333333310033333333333303333333333333333333333333333333333333310033333333333303333333333333333333333333333333333333310033333333330003333333333333333333333333333333333333330033333333330003333333333333333333333333333333333333310033333333330033333333333333333333333333333333333333310033333333330013333333333333333333333333333333333333310000000000000013333333333333333333333333333333333333310000000000000013333333333333333333333333333333333333331133311113331133333333333333333333331413334114333141333333333333333333333333333333333333300000000000000000133333333333333333333333333333333333300003333000000000433333333333333333333333333333333333330003333333333000133333333333333333333333333333333333340003333333333000333333333333333333333333333333333333310003333000000330333333333333333333333333333333333333310000000000000330333333333333333333333333333333333333340000000000000330133333333333333333333333333333333333331114411300000000133333333333333333333333333333333333334141413100000000433333333333333333333333333333333333310000001400333141333333333333333333333333333333333333310000004100341133333333333333333333333333333333333333330000003300000000133333333333333333333333333333333333303300000000000000133333333333333333333333333333333333303300000000000000433333333333333333333333333333333333330031143413114300333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333";
var d3 = "333333333333333333333333333333333333333333333333333333331411430033003411333333333333333333411300330034131433340000000033000000433333333333333334000000330000000013310000000000000000133333333333333331000033330000000043340000000000000000133333333333333334000033330333333013330000003114143000333333333333333333000000000333333033300330003441131000000330000000000000000000000000000003300330000000044000000330000000000000000000000000000003300330000033011000000000000000033000000003114311430333300330000033044000000000000000033000033004311314310333300330000000011000333333330033333333033001400000140003300330003141431000133333330033333331033004100000410003330000003141413000433333330033333331033001400000110033310333300000000000133333330033333331033004100000330043340333300000000000433333330033333331033001400000000013310000000000000000333333330033333333000003100000000013334111300003141314333333330033333333311133333414311433333333300003333333333114430031411333333333333333333333333333300003333333330000000000000033333333333333333333333333333003333333340000000000000013333333333333333333333333333003333333310033333333330043333333333333333333333333300003333333310033333333330013333333333333333333333333300003333333340033333333330013333333333333333333333333300003333333330033333333330033333333333333333333333333300000000000000033333333330003333333333333333333333333300000000000000033333333333303333333333333333333333333300003333333330033333333333303333333333333333333333333300003333333340033333333333303333333333333333333333333300003333333310033333333333303333333333333333333333333300333333333340033333333330003333333333333333333333333300333333333310000000000000333333333333333333333333333300003333333330000000000000333333333333333333333333333300003333333333141141300341333333333333333333333331411300003143143333333333333333333333333333333333333340000000000000000333333333333333333333333333333333333310000000000000330133333333333333333333333333333333333310000000000000330433333333333333333333333333333333333330000330003300330133333333333333333333333333333333333333000140004100330133333333333333333333333333333333333333000410001100000433333333333333333333333333333333333333000410001100000133333333333333333333333333333333333333000110004344311333333333333333333333333333333333333333000440003114314333333333333333333333333333333333333333000140000000000133333333333333333333333333333333333330000330000000000133333333333333333333333333333333333340000000033333300433333333333333333333333333333333333310000000033333300133333333333333333333333333333333333310000000000000000133333333333333333333333333333333333334131430000003141333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333";


var canvas = $("<canvas>");
var ctx = canvas[0].getContext("2d");
var sizeX = 54;
var sizeY = 50;
var step = 20;
var map = new Array(sizeX * sizeY);
var width = sizeX * (step) + 1;
var height = sizeY * (step) + 1;
var lastPos;
var mouseDown = false;
var fillAdd;
var ctrlDown = false;
var shiftDown = false;
var plusDown = false;
var minusDown = false;

function initCanvas() {
	canvas.attr("width", width);
	canvas.attr("height", height);
	ctx.imageSmoothingEnabled = false;
	
	//loadData(d1, 0, 0);
	//loadData(d2, 0, 0);
	loadData(d3, 0, 0);
	
	drawAll();
}

function loadData(data, sx, sy) {
	var nx, ny;
	for (var y = 0; y < sizeY; y++) {
		for (var x = 0; x < sizeX; x++) {
			nx = x + sx;
			ny = y + sy;
			if (nx >= sizeX) {
				break;
			}
			if (ny >= sizeY) {
				break;
			}
			map[nx + ny * sizeX] = data[x + y * sizeX];
		}
	} 
}

function drawBorder() {
	var i;
	for (i = 0; i <= sizeY; i++) {
		ctx.beginPath();
		ctx.moveTo(0, i * step);
		ctx.lineTo(width, i * step);
		ctx.stroke();
	}
	for (i = 0; i <= sizeX; i++) {
		ctx.beginPath();
		ctx.moveTo(i * step, 0);
		ctx.lineTo(i * step, height);
		ctx.stroke();
	}
}

function drawSq(x, y) {
	var pos = x + y * sizeX;
	if (map[pos] == 0 || !map[pos]) {
		ctx.fillStyle = "#FFFFFF";
	}
	else if (map[pos] == 1) {
		ctx.fillStyle = "#FF0000";
	}
	else if (map[pos] == 3) {
		ctx.fillStyle = "#666666";
	}
	else if (map[pos] == 4) {
		ctx.fillStyle = "#B59090";
	}
	else if (map[pos] == 5) {
		ctx.fillStyle = "#00FF0C";
	}
	ctx.fillRect(1 + x * step, 1 + y * step, step - 2, step - 2);
}

function drawAll() {
	ctx.fillStyle = "#FFFFFF";
	ctx.fillRect(0, 0, sizeX * step + 1, sizeY * step + 1);
	
	drawBorder();
	
	for (var y = 0; y < sizeY; y++) {
		for (var x = 0; x < sizeX; x++) {
			drawSq(x, y);
		}
	}
}

function encodeMap() {
	var enc = "";
	for (var i = 0; i < map.length; i++) {
		if (map[i]) {
			enc += map[i];
		}
		else {
			enc += 0;
		}
	}
	return enc;
}

$(document).ready(function() {
	
	initCanvas();
	drawBorder();
	$(".map-create").append(canvas);
	
	function put(x, y, num, cont) {
		if (plusDown || shiftDown) num = 4;
		if (minusDown) num = 5;
		var pos = x + y * sizeX;
		if (map[pos] == num && (!cont || !fillAdd)) {
			map[pos] = 0;
			if (!cont) {
				fillAdd = false;
			}
		}
		else if (!cont || fillAdd) {
			map[pos] = num;
			if (!cont) {
				fillAdd = true;
			}
		}
		drawSq(x, y);
	}
	
	function click(x, y, button) {
		x = parseInt((x - 1) / step);
		y = parseInt((y - 1) / step);
		lastPos = x + y * sizeX;
		put(x, y, button + 1, false);
	}
    
    function clickShift(x, y, button) {
        x = parseInt((x - 1) / step);
        y = parseInt((y - 1) / step);
        lastPos = x + y * sizeX;
        put(x, y, button + 1, false);
    }
	
	function clickCont(x, y, button) {
		x = parseInt((x - 1) / step);
		y = parseInt((y - 1) / step);
		if (lastPos != x + y * sizeX) {
			lastPos = x + y * sizeX;
			put(x, y, button + 1, true);
		}
	}
	
	function clickArea(x, y, button) {
		var lx = lastPos % sizeX;
		var ly = parseInt(lastPos / sizeX);
		
		x = parseInt((x - 1) / step);
		y = parseInt((y - 1) / step);
		alert(x + "," + y);
		return;
		lastPos = x + y * sizeX;
		
		var minX = Math.min(lx, x);
		var maxX = Math.max(lx, x);
		var minY = Math.min(ly, y);
		var maxY = Math.max(ly, y);
		
		for (y = minY; y <= maxY; y++) {
			for (x = minX; x <= maxX; x++) {
				put(x, y, button + 1, true);
			}
		}
	}
	
	$(document).keydown(function(e) {
		if (e.which == 32) {
			var enc = encodeMap();
			console.log(enc);
		}
        else if (e.which === 16) {
            // Shift
            shiftDown = true;
        }
		else if (e.which == 17) {
			ctrlDown = true;
		}
		else if (e.which == 187) {
			plusDown = true;
		}
		else if (e.which == 189) {
			minusDown = true;
		}
	});
	
	$(document).keyup(function(e) {
        if (e.which === 16) {
            // Shift
            shiftDown = false;
        }
		else if (e.which == 17) {
			ctrlDown = false;
		}
		else if (e.which == 187) {
			plusDown = false;
		}
		else if (e.which == 189) {
			minusDown = false;
		}
	});
	
	$(window).mousedown(function(e) {
		mouseDown = true;
		if (ctrlDown) {
			clickArea(e.offsetX, e.offsetY, e.button);
		}
        else if (shiftDown) {
            clickShift(e.offsetX, e.offsetY, e.button);
        }
		else {
			click(e.offsetX, e.offsetY, e.button);
		}
	});
	
	$(window).mouseup(function(e) {
		mouseDown = false;
	});
	
	$(canvas).mousemove(function(e) {
		if (mouseDown) {
			clickCont(e.offsetX, e.offsetY, e.button);
		}
	});
	
	$(canvas).bind('contextmenu', function(e){
		//click(e.offsetX, e.offsetY, e.button);
		return false;
	}); 
	
});